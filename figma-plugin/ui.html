<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Auto UI/UX Screen Builder</title>
    <style>
      body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: #0f172a;
        margin: 0;
        padding: 24px;
        color: #f8fafc;
      }
      h1 {
        font-size: 18px;
        margin: 0 0 12px;
      }
      label {
        display: block;
        font-size: 12px;
        margin-bottom: 4px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      input,
      textarea,
      button {
        width: 100%;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-family: inherit;
      }
      input,
      textarea {
        padding: 10px;
        margin-bottom: 12px;
        box-sizing: border-box;
        background: #1e293b;
        color: #f8fafc;
        border: 1px solid #334155;
      }
      textarea {
        min-height: 140px;
        resize: vertical;
      }
      button {
        background: #38bdf8;
        color: #0f172a;
        font-weight: 600;
        padding: 12px;
        margin-bottom: 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #0ea5e9;
      }
      button.secondary {
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #f8fafc;
      }
      button.secondary:hover {
        background: rgba(148, 163, 184, 0.1);
      }
      .section {
        margin-bottom: 20px;
      }
      .status {
        font-size: 12px;
        color: #fbbf24;
        min-height: 18px;
        padding: 8px;
        background: rgba(251, 191, 36, 0.1);
        border-radius: 4px;
        border-left: 3px solid #fbbf24;
      }
      a {
        color: #38bdf8;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .error {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
      }
      .success {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        border-left-color: #10b981;
      }
    </style>
  </head>
  <body>
    <h1>UI/UX Auto-Design Generator</h1>

    <div class="section">
      <label for="backendUrl">Backend Endpoint</label>
      <input
        id="backendUrl"
        type="url"
        value="http://localhost:8000/upload"
        placeholder="https://your-api.example.com/upload"
      />

      <label for="docInput">Upload PDF / DOCX</label>
      <input id="docInput" type="file" accept=".pdf,.docx,.doc" />

      <button id="analyzeBtn">Upload & Analyze</button>
    </div>

    <div class="section">
      <label for="jsonInput">UIReport JSON</label>
      <textarea
        id="jsonInput"
        placeholder='{"project_name": "...", "screens": [...]}'
      ></textarea>
      <button id="renderBtn">Render In Figma</button>
      <button id="clearBtn" class="secondary">Clear</button>
    </div>

    <p class="status" id="status"></p>
    <div class="section">
      <label>Latest Figma File</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <a id="figmaLink" href="#" target="_blank" rel="noreferrer" style="flex: 1; font-size: 12px; word-break: break-all;">â€”</a>
        <button id="openFigmaBtn" class="secondary" style="width: auto; padding: 8px 12px; font-size: 12px;" disabled>Open</button>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const jsonInput = document.getElementById("jsonInput");
      const figmaLink = document.getElementById("figmaLink");
      const openFigmaBtn = document.getElementById("openFigmaBtn");

      window.addEventListener('load', () => {
        setStatus("ðŸ’¡ Tip: Click the Figma link from your API response to create a new file, then run this plugin!", "success");
      });

      document.getElementById("analyzeBtn").addEventListener("click", async () => {
        const backendUrl = document.getElementById("backendUrl").value.trim();
        const file = document.getElementById("docInput").files[0];
        
        if (!backendUrl) {
          return setStatus("Please provide a backend endpoint.", "error");
        }
        if (!file) {
          return setStatus("Select a PDF or DOCX file first.", "error");
        }

        setStatus("Uploading documentâ€¦");
        try {
          const formData = new FormData();
          formData.append("file", file);
          const response = await fetch(backendUrl, {
            method: "POST",
            body: formData,
          });
          
          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || "Backend returned an error");
          }
          
          const data = await response.json();
          updateFigmaLink(data.figma_url);
          jsonInput.value = JSON.stringify(data.report, null, 2);
          postToFigma(data.report);
          setStatus("Report loaded. Renderingâ€¦");
        } catch (error) {
          console.error(error);
          setStatus(error.message || "Upload failed.", "error");
        }
      });

      document.getElementById("renderBtn").addEventListener("click", () => {
        if (!jsonInput.value.trim()) {
          return setStatus("Paste a UIReport JSON first.", "error");
        }
        
        try {
          const payload = JSON.parse(jsonInput.value);
          postToFigma(payload);
          setStatus("Rendering UI in Figmaâ€¦");
        } catch (error) {
          setStatus("Invalid JSON: " + error.message, "error");
        }
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        jsonInput.value = "";
        setStatus("Cleared.", "success");
      });

      openFigmaBtn.addEventListener("click", () => {
        if (figmaLink.href && figmaLink.href !== "#") {
          window.open(figmaLink.href, '_blank');
          setStatus("Figma file opened!", "success");
        }
      });

      onmessage = (event) => {
        const { type, payload } = event.data.pluginMessage || {};
        if (type === "STATUS") {
          setStatus(
            payload.ok ? "Finished rendering." : payload.message, 
            payload.ok ? "success" : "error"
          );
        }
      };

      function setStatus(message, type = "") {
        statusEl.textContent = message;
        statusEl.className = "status " + type;
      }

      function updateFigmaLink(url) {
        figmaLink.href = url;
        figmaLink.textContent = url;
        openFigmaBtn.disabled = !url || url === "#";
      }

      function postToFigma(payload) {
        parent.postMessage(
          { pluginMessage: { type: "GENERATE_UI", payload } },
          "*"
        );
      }
    </script>
  </body>
</html>